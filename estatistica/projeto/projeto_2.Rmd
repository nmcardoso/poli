---
title: "Projeto IMDB - Enunciado 2^[os números das seções são equivalentes aos números das perguntas.]"
author: "Natanael Magalhães Cardoso^[nUSP: 8914122. Usando dados para o segundo grupo (datas entre 2000-2010).]"
date: "31/05/2021"
#header-includes:
#  - \usepackage{enumitem}
output: 
  pdf_document:
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r lib, include=FALSE}
library(tidyverse)
library(readr)
library(ggpubr)
library(scales)
library(MASS)

imdb2 <- read_rds("imdb2.rds")
df_g2 <- imdb2 %>% filter(estreia=="2000-2010")
imdb2 <- imdb2 %>% mutate(Lucro=receita-orcamento)
df_g2 <- df_g2 %>% mutate(Lucro=receita-orcamento)
```

# Intervalo de confiança da média para variância populacional conhecida
\label{p1}

O parâmetro $\mu$ será estimado pelo estimador $\bar{x}$, que é definido pela Equação \eqref{eq:mean}.

\begin{equation}
\label{eq:mean}
\bar{x} = \frac{1}{n}\sum_i^n x_i
\end{equation}

Para um valor de $n$ suficientemente grande, a distribuição de $\bar{x}$ é normal. E, o intervalo que tem a probalidade $1 - \alpha$ de conter o verdadeiro valor do parâmetro $\mu$ da população é dado pela Equação \eqref{eq:mean-prob}. 

\begin{equation}
\label{eq:mean-prob}
P(\bar{x} - e_0 \le \mu \le \bar{x} + e_0) = 1 - \alpha
\end{equation}

Sendo assim, o intervalo de confiança da média considerando variância populacional $\sigma$ conhecida é expresso pela Equação \eqref{eq:mean-ic}.

\begin{equation}
\label{eq:mean-ic}
IC = \bar{x} \pm z_{\alpha / 2} \times \frac{\sigma}{\sqrt{n}}
\end{equation}

A Listagem a seguir mostra a implementação da função `IC_media_Z`, que calcula o intervalo de confiança da média para variância populacional conhecida.
Aplicando a função nos valores da coluna _Lucro_, para um nível de confiança de 95% e considerando a média populacional $\mu = 55\textrm{M}$, temos que $IC = [14.853.397; 20.182.038]$.

\bigskip

```{r q1}
IC_media_Z <- function(dados, confianca, dp) {
  xbarra = mean(dados, na.rm=TRUE)
  z = qnorm((1 + confianca) / 2)
  n = length(dados)
  e = z * (dp / sqrt(n))
  LS = xbarra + e
  LI = xbarra - e
  return(c(LI, LS))
}
IC_media_Z(imdb2$Lucro, 0.95, 55e6)
```

\bigskip

# Intervalo de confiança da média para variância populacional desconhecida
\label{p2}

É possível estimar o parâmetro $\mu$ de uma distribuição com variância populacional desconhecida a partir da estimação da variância pelo estimador variância amostral, $s$, que é definido na Equação \eqref{eq:s}, para $n \ge 30$.

\begin{equation}
\label{eq:s}
s = \sqrt{\frac{\sum_i^n (x_i - \bar{x})^2}{n-1}}
\end{equation}

Esta estimativa segue uma distribuição t-Student e o intervalo de confiança para média com variância populacional desconhecida é mostrado na Equação \eqref{eq:mean-ic2}.

\begin{equation}
\label{eq:mean-ic2}
IC = \bar{x} \pm t_{n-1; \alpha / 2} \times \frac{s}{\sqrt{n}}
\end{equation}

A Listagem a seguir mostra a implementação da função `IC_media_t`, que calcula o intervalo de confiança da média para variância populacional desconhecida.
Aplicando a função nos valores da coluna _Lucro_, para um nível de confiança de 95%, temos que o intervalo de confiança calculado é $IC = [14.467.782; 20.567.653]$.


\bigskip

```{r q2}
IC_media_t <- function(dados, confianca) {
  xbarra = mean(dados, na.rm=TRUE)
  n = length(dados)
  t = qt((1 + confianca) / 2, (n - 1))
  e = t * (sd(dados, na.rm=TRUE) / sqrt(n))
  LS = xbarra + e
  LI = xbarra - e
  return(c(LI, LS))
}
IC_media_t(imdb2$Lucro, 0.95)
```

\bigskip

# Criação da variável \texttt{Aprovado}
\label{p3}

A Listagem a seguir mostra a inclusão de uma nova coluna com valores booleanos no conjunto de dados principal e no subconjunto com filmes lançados entre 2000 e 2010. O campo recebe valor `verdadeiro` se a nota for maior que 6,5 e `falso` caso contrário.

\bigskip

```{r q3}
imdb2 <- imdb2 %>% mutate(
  Aprovado=ifelse(nota_imdb >= 6.5, TRUE, FALSE)
)
df_g2 <- imdb2 %>% mutate(
  Aprovado=ifelse(nota_imdb >= 6.5, TRUE, FALSE)
)
```

# Intervalo de confiança da proporção
\label{p4}

O estimador $p'$, definido na Equação \eqref{eq:p}, será usado para calcular a proporção.

\begin{equation}
\label{eq:p}
p' = \frac{f}{n}
\end{equation}

A distribuição de $p'$ é Binomial, mas, se $np \ge 5$ e $n(1-p) \ge 5$, ela pode ser aproximanda por uma Normal. 
Desta forma, o intervalo de confiança pode ser descrito pela Equação \eqref{eq:p-ic}.

\begin{equation}
\label{eq:p-ic}
IC = p' \pm z_{\alpha / 2}\sqrt{\frac{p'(1-p')}{n}}
\end{equation}`

A Listagem a seguir mostra a implementação da função `IC_prop`, que calcula o intervalo de confiança da proporção amostral.
Para \texttt{Aprovado = TRUE}, os intervalos de confiança para proporção são $IC_{80\%} = [0,499; 0,531]$, $IC_{95\%} = [0,491; 0,539]$ e $IC_{99\%} = [0,483; 0,547]$ para os níveis de confiança de 80, 95 e 95%, respectivamente. Foi notado que o intervalo **diminuiu** com o aumento do nível de confiança. Consequentemente, para \texttt{Aprovado = FALSE}, o intervalo  **aumentou** com o aumento do nível de confiança.

\bigskip

```{r q4}
IC_prop <- function(dados, confianca) {
  n = length(dados)
  z = qnorm((1 + confianca) / 2)
  p_linha = table(dados) / n
  e = z * sqrt((p_linha * (1 - p_linha)) / n)
  LS = p_linha + e
  LI = p_linha - e
  return(c(LI, LS))
}
IC_prop(imdb2$Aprovado, 0.80)
IC_prop(imdb2$Aprovado, 0.95)
IC_prop(imdb2$Aprovado, 0.99)
```

\bigskip

# Intervalo de confiança da variância
\label{p5}

O estimador $s$, definido na Equação \eqref{eq:p5-s}, será usado para estimar o parâmetro populacional $\mu$. Da Equação \eqref{eq:s}, temos

\begin{equation}
\label{eq:p5-s}
s^2 = \frac{\sum_i^n (x_i - \bar{x})^2}{n-1}
\end{equation}

Mas, se $X \sim \mathcal{N}(\mu; \sigma) \quad \Rightarrow \quad s^2 \sim \chi^2_{n-1}$. Então

\begin{equation}
s^2 = \frac{\sigma^2}{n-1} \chi^2_{n-1}
\end{equation}

Assim, o intervalo de confiança $IC$ da variância é dado por

\begin{equation}
IC = \left[\sqrt{\frac{(n-1)s^2}{\chi^2_{n-1;\alpha/2}}} ; \sqrt{\frac{(n-1)s^2}{\chi^2_{n-1;1-\alpha/2}}} \right]
\end{equation}

A Listagem a seguir mostra a implementação da função `IC_var`, que calcula o intervalo de confiança da variância.
O intervalo de confiança da variância do lucro, considerando um nível de confiança de 95\%, é $IC = [60.830.134; 65.146.228]$.

\bigskip

```{r q5}
IC_var <- function(dados, confianca) {
  gl = length(dados) - 1
  S = var(dados, na.rm=TRUE)
  chi_lower = qchisq((1 + confianca) / 2, gl)
  chi_upper = qchisq((1 - confianca) / 2, gl)
  LI = sqrt(gl * S / chi_lower) 
  LS = sqrt(gl * S / chi_upper)
  return(c(LI, LS))
}
IC_var(imdb2$Lucro, 0.95)
```

\bigskip

# Análise visual da distribuição `Aprovado`

```{r q6}
p1 <- df_g2 %>% ggplot(aes(x=Aprovado, y=Lucro)) +
  geom_boxplot(aes(fill=Aprovado)) +
  theme(legend.position="none") +
  scale_y_continuous(labels=unit_format(unit="M", scale=1e-6)) +
  labs(
    x="Aprovado",
    y="Lucro",
    title="Gráfico de Boxplot",
    subtitle="Lucro em função de aprovação"
  )

p2 <- df_g2 %>% ggplot(aes(x=Aprovado, y=Lucro)) +
  theme(legend.position="none") +
  geom_jitter(aes(colour=Aprovado)) +
  scale_y_continuous(labels=unit_format(unit="M", scale=1e-6)) +
  labs(
    x="Aprovado",
    y="Lucro",
    title="Stripchart",
    subtitle="Lucro em função de aprovação"
  )

ggarrange(p1, p2, ncol=2)
```

# Teste de igualdade de variâncias: Teste-F
\label{p7}

# Teste de igualdade de médias: Teste-t
\label{p8}

# Pergunta 09

# Inspeção visual da normalidade: Papel de probabilidade normal
fit <- fitdistr(df_g2$nota_imdb, "normal")
MI <- fit$estimate[1]
SIGMA <- fit$estimate[2]

plot3 <- df_g2 %>% ggplot(aes(x=nota_imdb)) +
  geom_histogram(aes(y=..density..), bins=10, colour="black", fill="tan1") +
  labs(
    x="Nota imdb",
    y="Densidade de frequência",
    title="Histograma de densidade\nde frequência",
    subtitle="Nota IMDB"
  ) +
  stat_function(
    fun=dnorm,
    args=list(mean=MI, sd=SIGMA),
    size=1,
    col="black",
    linetype=1
  )

plot4 <- df_g2 %>% ggplot(aes(sample=nota_imdb)) +
  geom_qq_line(colour="darkorange4") +
  geom_qq(shape=21, colour="tan4", fill="tan1", size=3) +
  labs(
    x="Quantis teóricos",
    y="Quantis amostrais",
    title="Papel de probabilidade normal",
    subtitle="Nota IMDB"
  )

ggarrange(plot3, plot4, ncol=2)
```

# Teste de normalidade: Teste Kolmogorov-Smirnov

# Pergunta 10

```{r q10, warning=FALSE}
x = df_g2$nota_imdb
KS_teste <- ks.test(x, "pnorm", mean=mean(x), sd=sd(x))
KS_teste
```




